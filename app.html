<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã¿ã‚“ã‚‰ã¼ã‚«ãƒ¼ãƒ‰ã‚²ãƒ¼ãƒ </title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¤–éƒ¨è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆAPIã‚­ãƒ¼æ³¨å…¥ç”¨ï¼‰ã€‚æœ¬ç•ªã¯ GitHub Actions ã§ç”Ÿæˆ -->
    <script src="config.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap');
        body { font-family: 'Noto Sans JP', sans-serif; }
        
        .card {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .card:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
        }
        
        .card.selected {
            transform: translateY(-8px);
            box-shadow: 0 0 0 4px #3b82f6;
            border-color: #3b82f6 !important;
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
        }
        
        .card.selected::before {
            content: "âœ“ é¸æŠä¸­";
            position: absolute;
            top: -10px;
            right: -10px;
            background: #3b82f6;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .card.final-selected {
            transform: translateY(-8px);
            box-shadow: 0 0 0 4px #8b5cf6;
            border-color: #8b5cf6 !important;
            background: linear-gradient(135deg, #f3e8ff 0%, #e9d5ff 100%);
        }
        
        .card.final-selected::before {
            content: "â˜… æœ€çµ‚é¸æŠ";
            position: absolute;
            top: -10px;
            right: -10px;
            background: #8b5cf6;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .exchange-animation {
            animation: exchangeFlow 2s ease-in-out;
        }
        
        @keyframes exchangeFlow {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.3; transform: scale(0.95); }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-purple-100 via-blue-50 to-indigo-100 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-800 mb-2">ğŸ® ã¿ã‚“ã‚‰ã¼ã‚«ãƒ¼ãƒ‰ã‚²ãƒ¼ãƒ </h1>
            <p class="text-gray-600 text-lg">äººç”Ÿã®æœ€æœŸã«å¤§åˆ‡ãªã‚‚ã®ã‚’è¦‹ã¤ã‘ã‚‹æ—…</p>
        </div>

        <!-- ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
            <div class="flex justify-between items-center mb-4">
                <div class="text-lg font-semibold text-gray-700" id="stepTitle">ã‚²ãƒ¼ãƒ é–‹å§‹</div>
                <div class="text-sm text-gray-500" id="roundInfo">æº–å‚™ä¸­</div>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-3">
                <div class="bg-gradient-to-r from-purple-500 to-blue-500 h-3 rounded-full transition-all duration-500" id="progressBar" style="width: 0%"></div>
            </div>
        </div>

        <!-- ã‚²ãƒ¼ãƒ é–‹å§‹ç”»é¢ -->
        <div id="startScreen" class="text-center bg-white rounded-xl shadow-lg p-12 fade-in">
            <div class="text-6xl mb-6">ğŸ´</div>
            <h2 class="text-2xl font-bold text-gray-800 mb-4">ã¿ã‚“ã‚‰ã¼ã‚«ãƒ¼ãƒ‰ã‚²ãƒ¼ãƒ </h2>
            <div class="text-gray-600 mb-8 max-w-2xl mx-auto leading-relaxed space-y-4">
                <p><strong>ã‚ãªãŸãŒä½™å‘½2ãƒ¶æœˆã¨å®£å‘Šã•ã‚ŒãŸå ´åˆã‚’æƒ³å®šã—ã¦ã”å‚åŠ ã„ãŸã ãã¾ã™ã€‚</strong></p>
                <p>ä»Šã®ã‚ãªãŸã¯ç—›ã¿ã‚‚ãªãæ™®é€šã«æ­©ãã“ã¨ãŒã§ãã€æ„è­˜ã¯ã¯ã£ãã‚Šã—ã¦ã„ã¾ã™ã€‚</p>
                <p>ã“ã®ã‚²ãƒ¼ãƒ ã§ã¯ã€äººç”Ÿã®æœ€æœŸã«å‘ã‘ã¦ä½•ã‚’å¤§åˆ‡ã«ã—ãŸã„ã‹ã‚’æ·±ãè€ƒãˆã¦ã„ãŸã ãã¾ã™ã€‚</p>
                <p>3å›ã®äº¤æ›ã‚’é€šã˜ã¦ã€æœ€çµ‚çš„ã«1æšã®æœ€ã‚‚å¤§åˆ‡ãªã‚«ãƒ¼ãƒ‰ã‚’è¦‹ã¤ã‘ã¦ã„ãã¾ã—ã‚‡ã†ã€‚</p>
            </div>
            <button onclick="startGame()" class="bg-gradient-to-r from-purple-500 to-blue-500 text-white px-8 py-4 rounded-lg font-semibold text-lg hover:from-purple-600 hover:to-blue-600 transition-all duration-300 transform hover:scale-105">
                ã‚²ãƒ¼ãƒ é–‹å§‹
            </button>
        </div>

        <!-- ãƒ¡ã‚¤ãƒ³ã‚²ãƒ¼ãƒ ç”»é¢ -->
        <div id="gameScreen" class="hidden">
            <!-- ãƒ«ãƒ¼ãƒ«èª¬æ˜ -->
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                <h4 class="font-semibold text-blue-800 mb-2">ğŸ“‹ ãƒ«ãƒ¼ãƒ«èª¬æ˜</h4>
                <p class="text-blue-700 text-sm">
                    æ‰‹æœ­ã‹ã‚‰æ¨ã¦ãŸã„ã‚«ãƒ¼ãƒ‰ã¨ã€å ´ã‹ã‚‰å–ã‚ŠãŸã„ã‚«ãƒ¼ãƒ‰ã‚’<strong>åŒã˜æšæ•°</strong>é¸ã‚“ã§äº¤æ›ã—ã¾ã™ã€‚
                    ã‚«ãƒ¼ãƒ‰ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨é¸æŠã•ã‚Œã€ã‚‚ã†ä¸€åº¦ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨é¸æŠãŒå¤–ã‚Œã¾ã™ã€‚
                </p>
            </div>

            <!-- ç¾åœ¨ã®æŒ‡ç¤º -->
            <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-6">
                <h4 class="font-semibold text-green-800 mb-2">ğŸ¯ ç¾åœ¨ã®æ‰‹é †</h4>
                <p class="text-green-700 text-sm" id="instructionText">
                    æ‰‹æœ­ã‹ã‚‰æ¨ã¦ãŸã„ã‚«ãƒ¼ãƒ‰ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦é¸æŠã—ã¦ãã ã•ã„ã€‚
                </p>
            </div>

            <!-- æ‰‹æœ­ã‚¨ãƒªã‚¢ -->
            <div class="mb-8">
                <h3 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                    <span class="mr-2">ğŸ¤²</span>ã‚ãªãŸã®æ‰‹æœ­
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="handCards"></div>
            </div>

            <!-- å ´ã®ã‚«ãƒ¼ãƒ‰ã‚¨ãƒªã‚¢ -->
            <div class="mb-8">
                <h3 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                    <span class="mr-2">ğŸ´</span>å ´ã®ã‚«ãƒ¼ãƒ‰ï¼ˆäº¤æ›å€™è£œï¼‰
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="fieldCards"></div>
            </div>

            <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ -->
            <div class="text-center" id="actionButtons">
                <button onclick="skipExchange()" class="bg-gray-500 text-white px-6 py-3 rounded-lg font-semibold hover:bg-gray-600 transition-all duration-300">
                    äº¤æ›ã‚’ã‚¹ã‚­ãƒƒãƒ—
                </button>
            </div>
            
            <!-- é¸æŠæšæ•°è¡¨ç¤º -->
            <div class="text-center mt-4" id="selectionCount">
                <div class="bg-gray-50 border border-gray-200 rounded-lg p-3 inline-block">
                    <div class="text-sm text-gray-600">
                        <span class="font-semibold">é¸æŠä¸­:</span>
                        <span class="text-blue-600 font-bold">æ‰‹æœ­ <span id="handCount">0</span>æš</span>
                        <span class="mx-2">|</span>
                        <span class="text-green-600 font-bold">å ´ <span id="fieldCount">0</span>æš</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- æœ€çµ‚é¸æŠç”»é¢ -->
        <div id="finalScreen" class="hidden">
            <div class="bg-white rounded-xl shadow-lg p-8">
                <!-- ãƒ«ãƒ¼ãƒ«èª¬æ˜ -->
                <div class="bg-purple-50 border border-purple-200 rounded-lg p-4 mb-6">
                    <h4 class="font-semibold text-purple-800 mb-2">ğŸ“‹ æœ€çµ‚é¸æŠ</h4>
                    <p class="text-purple-700 text-sm">
                        æ‰‹æœ­ã®ä¸­ã‹ã‚‰<strong>æœ€ã‚‚å¤§åˆ‡ãª1æš</strong>ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚é¸æŠã—ãŸã‚«ãƒ¼ãƒ‰ã¯ç´«ã®æ ã§å›²ã¾ã‚Œã¾ã™ã€‚
                    </p>
                </div>

                <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">ğŸŒŸ æœ€ã‚‚å¤§åˆ‡ãª1æšã‚’é¸ã‚“ã§ãã ã•ã„</h2>
                <div class="text-center mb-6 text-gray-600">
                    <p class="text-sm">ã‚«ãƒ¼ãƒ‰ã‚’é¸ã‚“ã å¾Œã€ãã®ã‚«ãƒ¼ãƒ‰ã«ã¤ã„ã¦è©³ã—ãæ•™ãˆã¦ãã ã•ã„</p>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8" id="finalCards"></div>
                
                <!-- ç†ç”±å…¥åŠ›ã‚¨ãƒªã‚¢ -->
                <div id="reasonSection" class="hidden">
                    <div class="mb-3">
                        <h4 class="font-semibold text-gray-800 mb-2">ğŸ“ é¸æŠã—ãŸã‚«ãƒ¼ãƒ‰ã«ã¤ã„ã¦æ•™ãˆã¦ãã ã•ã„ï¼š</h4>
                        <div class="text-sm text-gray-600 mb-3 bg-blue-50 border border-blue-200 rounded-lg p-3">
                            <p class="mb-2">ã“ã®ã‚«ãƒ¼ãƒ‰ã«æ›¸ã„ã¦ã‚ã‚‹ã“ã¨ã‚’ã€æ›¸ã‘ã‚‹ç¯„å›²ã§å…·ä½“çš„ã«æ›¸ã„ã¦ã¿ã¦ãã ã•ã„ã€‚</p>
                            <p class="text-xs text-gray-500 mb-2">ä»¥ä¸‹ã®é …ç›®ã¯å‚è€ƒä¾‹ã§ã™ã€‚å½“ã¦ã¯ã¾ã‚‰ãªã„å ´åˆã‚„æ›¸ãã«ãã„é …ç›®ãŒã‚ã‚Œã°ã€ç„¡ç†ã«å…¨ã¦åŸ‹ã‚ã‚‹å¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“ï¼š</p>
                            <ul class="text-xs text-gray-500 space-y-1 ml-4">
                                <li>â€¢ <strong>ã„ã¤</strong>ï¼šã©ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ï¼ˆä¾‹ï¼šæœ€æœŸã®1ãƒ¶æœˆé–“ã«ï¼‰</li>
                                <li>â€¢ <strong>ã©ã“ã§</strong>ï¼šã©ã®å ´æ‰€ã§ï¼ˆä¾‹ï¼šè‡ªå®…ã®ãƒªãƒ“ãƒ³ã‚°ã§ï¼‰</li>
                                <li>â€¢ <strong>ã ã‚Œã¨</strong>ï¼šã©ã‚“ãªäººã¨ä¸€ç·’ã«ï¼ˆä¾‹ï¼šå®¶æ—ã¨ï¼‰</li>
                                <li>â€¢ <strong>ã©ã‚“ãªãµã†ã«</strong>ï¼šã©ã®ã‚ˆã†ãªå½¢ã§ï¼ˆä¾‹ï¼šæ¯æ—¥å¤•é£Ÿã‚’ä¸€ç·’ã«ï¼‰</li>
                            </ul>
                        </div>
                        <p class="text-sm text-gray-600">ã‚ãªãŸãªã‚Šã®æƒ³ã„ã‚„è€ƒãˆã‚’ã€è‡ªç”±ã«è¡¨ç¾ã—ã¦ãã ã•ã„ã€‚</p>
                    </div>
                    <textarea id="reasonText" placeholder="ä¾‹ï¼šã€Œã„ã¤ã€æœ€æœŸã®1ãƒ¶æœˆé–“ã«ã€ã€Œã©ã“ã§ã€è‡ªå®…ã®ãƒªãƒ“ãƒ³ã‚°ã§ã€ã€Œã ã‚Œã¨ã€å®¶æ—å…¨å“¡ã¨ã€ã€Œã©ã‚“ãªãµã†ã«ã€æ¯æ—¥å¤•é£Ÿã‚’ä¸€ç·’ã«é£Ÿã¹ãªãŒã‚‰ã€ä»Šæ—¥ã‚ã£ãŸã“ã¨ã‚’è©±ã—åˆã„ãŸã„..." class="w-full p-4 border border-gray-300 rounded-lg resize-none h-40 mb-4"></textarea>
                    <div class="mb-4 text-sm text-gray-600 bg-yellow-50 border border-yellow-200 rounded-lg p-3">
                        <span class="font-semibold text-yellow-800">âš ï¸ ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ã«é–¢ã™ã‚‹æ³¨æ„ï¼š</span><br>
                        ç‰¹å®šã§ãã‚‹ã‚ˆã†ãªå€‹äººåï¼ˆå®Ÿåãƒ»ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ï¼‰ã¯å…¥åŠ›ã—ãªã„ã§ãã ã•ã„ã€‚ä¸€èˆ¬çš„ãªé–¢ä¿‚æ€§ï¼ˆã€Œå®¶æ—ã€ã€Œå‹äººã€ãªã©ï¼‰ã§ã”è¨˜å…¥ãã ã•ã„ã€‚
                    </div>
                    <div class="text-center">
                        <button onclick="generateArtwork()" class="bg-gradient-to-r from-purple-500 to-pink-500 text-white px-8 py-4 rounded-lg font-semibold text-lg hover:from-purple-600 hover:to-pink-600 transition-all duration-300">
                            çµµç”»ã‚’ç”Ÿæˆã™ã‚‹
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- å®Œäº†ç”»é¢ -->
        <div id="completeScreen" class="hidden">
            <div class="bg-white rounded-xl shadow-lg p-8">
                <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">ğŸ‰ ã‚²ãƒ¼ãƒ å®Œäº†ï¼</h2>
                
                <!-- é¸æŠã•ã‚ŒãŸã‚«ãƒ¼ãƒ‰è¡¨ç¤º -->
                <div class="text-center mb-8">
                    <div class="text-lg font-semibold text-gray-700 mb-2">ã‚ãªãŸãŒé¸ã‚“ã æœ€ã‚‚å¤§åˆ‡ãªã‚«ãƒ¼ãƒ‰:</div>
                    <div id="selectedCardDisplay" class="text-xl text-purple-600 font-bold mb-6 p-4 bg-purple-50 rounded-lg"></div>
                    
                    <!-- ç”Ÿæˆã•ã‚ŒãŸçµµç”» -->
                    <div class="mb-6">
                        <div id="artworkContainer" class="w-80 h-80 mx-auto bg-gradient-to-br from-purple-200 to-blue-200 rounded-lg flex items-center justify-center text-6xl border-4 border-purple-300">
                            ğŸ¨
                        </div>
                        <div id="generationStatus" class="text-sm text-gray-500 mt-2">ã‚ãªãŸã®é¸æŠã‚’è¡¨ç¾ã—ãŸçµµç”»</div>
                    </div>
                </div>
                
                <!-- ã‚²ãƒ¼ãƒ æŒ¯ã‚Šè¿”ã‚Š -->
                <div class="mb-8">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4 text-center">ğŸ“‹ ã‚²ãƒ¼ãƒ ã®æŒ¯ã‚Šè¿”ã‚Š</h3>
                    <div id="gameSummary"></div>
                </div>
                
                <!-- æŒ¯ã‚Šè¿”ã‚Šã®ã‚¢ãƒ‰ãƒã‚¤ã‚¹ -->
                <div class="bg-gradient-to-r from-blue-50 to-purple-50 border border-blue-200 rounded-lg p-6 mb-6">
                    <h3 class="text-lg font-semibold text-blue-800 mb-3 flex items-center">
                        <span class="mr-2">ğŸ’­</span>æŒ¯ã‚Šè¿”ã‚Šã®ã™ã™ã‚
                    </h3>
                    <div class="text-blue-700 space-y-3">
                        <p class="font-medium">ğŸ”„ <strong>äº¤æ›ã—ãŸã‚«ãƒ¼ãƒ‰ã‚’è¦‹ç›´ã—ã¦ã¿ã¾ã—ã‚‡ã†</strong></p>
                        <p class="text-sm">æ‰‹æ”¾ã—ãŸã‚«ãƒ¼ãƒ‰ã¨å–å¾—ã—ãŸã‚«ãƒ¼ãƒ‰ã‚’è¦‹æ¯”ã¹ã‚‹ã“ã¨ã§ã€ã‚ãªãŸã®ä¾¡å€¤è¦³ã®å¤‰åŒ–ãŒè¦‹ãˆã¦ãã¾ã™ã€‚</p>
                        
                        <p class="font-medium">ğŸ’¬ <strong>å‘¨ã‚Šã®äººã«è©±ã—ã¦ã¿ã¾ã—ã‚‡ã†</strong></p>
                        <p class="text-sm">ãªãœãã®ã‚«ãƒ¼ãƒ‰ã‚’é¸ã‚“ã ã®ã‹ã€å®¶æ—ã‚„å‹äººã«è©±ã—ã¦ã¿ã¦ãã ã•ã„ã€‚è©±ã™ã“ã¨ã§ã€ã‚ãªãŸãŒæœ¬å½“ã«å¤§äº‹ã«ã—ã¦ã„ã‚‹ã“ã¨ãŒæ˜ç¢ºã«ãªã‚Šã¾ã™ã€‚</p>
                        
                        <p class="font-medium">âœ¨ <strong>ã‚ãªãŸã®ä¾¡å€¤è¦³ã‚’ç™ºè¦‹</strong></p>
                        <p class="text-sm">ã“ã®ã‚²ãƒ¼ãƒ ã‚’é€šã˜ã¦è¦‹ãˆã¦ããŸã€Œå¤§åˆ‡ãªã‚‚ã®ã€ã¯ã€æ—¥å¸¸ç”Ÿæ´»ã§ã‚‚æ„è­˜ã—ã¦ã¿ã¦ãã ã•ã„ã€‚ãã‚ŒãŒã‚ãªãŸã‚‰ã—ã„ç”Ÿãæ–¹ã«ã¤ãªãŒã‚Šã¾ã™ã€‚</p>
                    </div>
                </div>
                
                <div class="text-gray-600 mb-6 text-center space-y-2">
                    <p>ã“ã®ã‚«ãƒ¼ãƒ‰ãŒã‚ãªãŸã®äººç”Ÿã®æœ€æœŸã«ãŠã„ã¦ç‰¹åˆ¥ãªæ„å‘³ã‚’æŒã¤ã“ã¨ã‚’é¡˜ã£ã¦ã„ã¾ã™ã€‚</p>
                    <p>é™ã‚‰ã‚ŒãŸæ™‚é–“ã®ä¸­ã§ã€ä½•ã‚’å¤§åˆ‡ã«ã—ã¦ç”Ÿãã‚‹ã‹ã€æ·±ãè€ƒãˆã‚‹ãã£ã‹ã‘ã«ãªã‚Œã°å¹¸ã„ã§ã™ã€‚</p>
                    <p class="text-sm italic">â€»ã“ã®ã‚²ãƒ¼ãƒ ã¯çµ‚æœ«æœŸåŒ»ç™‚ã‚„äººç”Ÿã®ä¾¡å€¤ã«ã¤ã„ã¦è€ƒãˆã‚‹ãŸã‚ã®ãƒ„ãƒ¼ãƒ«ã§ã™ã€‚</p>
                </div>
                
                <div class="text-center" id="finalButtons">
                    <button onclick="restartGame()" class="bg-gradient-to-r from-purple-500 to-blue-500 text-white px-6 py-3 rounded-lg font-semibold hover:from-purple-600 hover:to-blue-600 transition-all duration-300">
                        ã‚‚ã†ä¸€åº¦ãƒ—ãƒ¬ã‚¤ã™ã‚‹
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ã‚²ãƒ¼ãƒ çŠ¶æ…‹ç®¡ç†
        let gameState = {
            step: 0, // 0:é–‹å§‹, 1:äº¤æ›ãƒ•ã‚§ãƒ¼ã‚º, 2:æœ€çµ‚é¸æŠ, 3:å®Œäº†
            round: 0, // ç¾åœ¨ã®äº¤æ›ãƒ©ã‚¦ãƒ³ãƒ‰ (0-2)
            hand: [], // æ‰‹æœ­
            field: [], // å ´ã®ã‚«ãƒ¼ãƒ‰
            selectedHand: [], // é¸æŠã•ã‚ŒãŸæ‰‹æœ­ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
            selectedField: [], // é¸æŠã•ã‚ŒãŸå ´ã®ã‚«ãƒ¼ãƒ‰ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
            finalCard: null, // æœ€çµ‚é¸æŠã•ã‚ŒãŸã‚«ãƒ¼ãƒ‰
            finalReason: '', // é¸æŠç†ç”±
            exchangeHistory: [], // äº¤æ›å±¥æ­´
            allCards: [] // å…¨ã‚«ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿
        };

        // ã‚«ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ï¼ˆçµ‚æœ«æœŸåŒ»ç™‚é–¢é€£ã®52æšï¼‰
        const cardData = [
            "è‡ªåˆ†ã®ä½“ãŒç—…çŠ¶ã¨ã¨ã‚‚ã«ã©ã†å¤‰åŒ–ã™ã‚‹ã‹ã‚’çŸ¥ã‚‹",
            "åŒ»ç™‚æ©Ÿå™¨ã‚’ä½¿ç”¨ã—ãªã„",
            "æ®‹ã£ã¦ã„ã‚‹èº«ä½“ã®æ©Ÿèƒ½ã‚’æ´»ã‹ã—ãŸã‚±ã‚¢ã‚’å—ã‘ã‚‹",
            "æœ›ã‚“ã æ²»ç™‚ã‚„ã‚±ã‚¢ã‚’å—ã‘ã‚‹",
            "å°Šå³ã‚’ä¿ã¤",
            "èª°ã‹ã®å½¹ã«ç«‹ã£ã¦ã„ã‚‹",
            "æ‡ºæ‚”ã™ã‚‹",
            "æœ€æœŸã¾ã§æ€§çš„ãªæ´»å‹•ã‚’ç¶­æŒã™ã‚‹",
            "è‡ªåˆ†ã®æƒ³ã„ã‚’èã„ã¦ãã‚Œã‚‹äººãŒã„ã‚‹",
            "è‡ªåˆ†ã®æœ›ã¿ã‚’å®¶æ—ã¨å…±æœ‰ã™ã‚‹",
            "è¦ªå‹ãŒè¿‘ãã«ã„ã‚‹",
            "è¦ªã—ã„äººã¨æ¸©ã‹ãã¤ãªãŒã£ã¦ã„ã‚‹",
            "æœ€æœŸã¯èª°ã‹ã¨ä¸€ç·’ã«ã„ã‚‹",
            "è‘¬å„€ã®å‚åˆ—è€…ã‚’ã‚ã‚‰ã‹ã˜ã‚æ±ºã‚ã¦ãŠã",
            "å¤§åˆ‡ãªäººã«åˆ¥ã‚Œã®æŒ¨æ‹¶ã‚’ã™ã‚‹",
            "è¦ªã—ã„äººã¨ãƒã‚°ã™ã‚‹",
            "è‡ªåˆ†ã®æœ€æœŸãŒè¿‘ã„ã“ã¨ã‚’å®¶æ—ãŒèªã‚ã¦ã„ã‚‹",
            "è‡ªåˆ†ãŒå®¶æ—ã®è² æ‹…ã«ãªã‚‰ãªã„",
            "è‡ªåˆ†ã®æ„æ€ã‚’ä»£å¼ã™ã‚‹æ”¯æ´è€…ãŒã„ã‚‹",
            "ææ€–ã‚„ä¸å®‰ã«ã¤ã„ã¦è©±ã™",
            "å¿ƒã‹ã‚‰ä¿¡é ¼ã§ãã‚‹åŒ»ç™‚è€…ãŒã„ã‚‹",
            "æ¸…æ½”ã‚’ä¿ã¤",
            "æ„è­˜ãŒã¯ã£ãã‚Šã—ã¦ã„ã‚‹",
            "ãƒ¦ãƒ¼ãƒ¢ã‚¢ã‚’ä¿ã¤",
            "è‡ªå®…ã§æœ€æœŸã‚’è¿ãˆã‚‹",
            "ä¸å®‰ãŒãªã„",
            "æ¯è‹¦ã—ã•ã‚„ç—›ã¿ãŒãªã„",
            "è‡ªå®…ãƒ»æ–½è¨­ãƒ»ç—…é™¢ã‚’å•ã‚ãšé™ã‹ãªç’°å¢ƒã§éã”ã™",
            "æµ·ã‚„æ£®ãªã©è‡ªç„¶ã«è§¦ã‚Œã‚‹",
            "æ¡œã‚„èŠ±ã‚’æ„›ã§ã‚‹",
            "æ—…è¡Œã«å‡ºã‹ã‘ã‚‹",
            "è©±ã‚’èã„ã¦ãã‚Œã‚‹è‡¨åºŠå®—æ•™å¸«ãŒã„ã‚‹",
            "ã‚„ã£ã¦ã¿ãŸã‹ã£ãŸã“ã¨ã«æŒ‘æˆ¦ã™ã‚‹",
            "ã‚„ã‚Šæ®‹ã—ãŸä»•äº‹ã«å–ã‚Šæ›ã‹ã‚‹",
            "å®¶æ—ã‚„å‹äººã¨ã‚„ã‚Šæ®‹ã—ãŸã“ã¨ã‚’ç‰‡ä»˜ã‘ã‚‹",
            "å¥½ããªé‹å‹•ã‚’ã™ã‚‹",
            "å¥½ããªã‚‚ã®ã‚’é£Ÿã¹ã‚‹",
            "å¥½ããªæœ¬ã‚’èª­ã‚€",
            "å¥½ããªè©©ã‚’å”„ã†",
            "ãƒ‘ã‚½ã‚³ãƒ³ã‚„ã‚¹ãƒãƒ›ã®ãƒ‡ãƒ¼ã‚¿ã‚’æ•´ç†ã™ã‚‹",
            "æœ¬æ£šã®æ•´ç†ã‚’ã™ã‚‹",
            "ãŠé‡‘ãªã©ç›¸ç¶šã«ã¤ã„ã¦æ•´ç†ã™ã‚‹",
            "å‰ã‚‚ã£ã¦è‡ªåˆ†ã®å¢“ã‚’ä½œã‚‹",
            "è¿‘æ‰€ã®äººã«æŒ¨æ‹¶ã‚’ã™ã‚‹",
            "Social Network Serviceã‚„ãƒ¡ãƒ¼ãƒ«ã§æŒ¨æ‹¶ã™ã‚‹",
            "æœ€æœŸã«å‘¨ã‚Šã®äººã«ç¬‘ã£ã¦ã‚‚ã‚‰ã†",
            "éºæ›¸ã‚’æ›¸ã„ã¦ãã®åœ¨ã‚Šå‡¦ã‚’äººã«è©±ã™",
            "å¹´è¶Šã—ã‚’ã™ã‚‹",
            "ç‘æƒ³ã«ãµã‘ã‚‹",
            "äººç”Ÿã®æ„å‘³ã‚’å•ã†",
            "ç¥ˆã‚‹",
            "è‡ªåˆ†ã®å¹¸ã›ã‚’å•ã†"
        ];

        // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
        function shuffleArray(array) {
            const newArray = [...array];
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
        }

        function updateProgressBar() {
            const progress = (gameState.step / 3) * 100;
            document.getElementById('progressBar').style.width = `${progress}%`;
            
            const stepTitles = ['ã‚²ãƒ¼ãƒ é–‹å§‹', 'äº¤æ›ãƒ•ã‚§ãƒ¼ã‚º', 'æœ€çµ‚é¸æŠ', 'å®Œäº†'];
            document.getElementById('stepTitle').textContent = stepTitles[gameState.step];
            
            if (gameState.step === 1) {
                document.getElementById('roundInfo').textContent = `äº¤æ› ${gameState.round + 1}/3`;
            } else {
                document.getElementById('roundInfo').textContent = '';
            }
        }

        // ã‚²ãƒ¼ãƒ é–‹å§‹
        function startGame() {
            gameState.allCards = shuffleArray([...cardData]);
            gameState.hand = gameState.allCards.slice(0, 4);
            gameState.field = gameState.allCards.slice(4, 8);
            gameState.step = 1;
            gameState.round = 0;
            gameState.selectedHand = [];
            gameState.selectedField = [];
            gameState.exchangeHistory = [];
            
            document.getElementById('startScreen').classList.add('hidden');
            document.getElementById('gameScreen').classList.remove('hidden');
            
            updateProgressBar();
            renderGameScreen();
        }

        // ã‚²ãƒ¼ãƒ ç”»é¢ã®æç”»
        function renderGameScreen() {
            renderHandCards();
            renderFieldCards();
            updateInstructions();
            updateActionButtons();
        }

        function renderHandCards() {
            const container = document.getElementById('handCards');
            container.innerHTML = '';
            
            gameState.hand.forEach((card, index) => {
                const cardElement = createCardElement(card, 'hand', index);
                container.appendChild(cardElement);
            });
        }

        function renderFieldCards() {
            const container = document.getElementById('fieldCards');
            container.innerHTML = '';
            
            gameState.field.forEach((card, index) => {
                const cardElement = createCardElement(card, 'field', index);
                container.appendChild(cardElement);
            });
        }

        function createCardElement(cardText, type, index) {
            const div = document.createElement('div');
            div.className = 'card bg-white rounded-lg shadow-md p-4 border-2 border-gray-200 min-h-32 flex items-center justify-center text-center relative';
            div.innerHTML = `<div class="text-gray-800 font-medium">${cardText}</div>`;
            
            div.onclick = () => selectCard(type, index);
            
            // é¸æŠçŠ¶æ…‹ã®åæ˜ 
            if (type === 'hand' && gameState.selectedHand.includes(index)) {
                div.classList.add('selected');
            } else if (type === 'field' && gameState.selectedField.includes(index)) {
                div.classList.add('selected');
            }
            
            return div;
        }

        function selectCard(type, index) {
            if (type === 'hand') {
                const selectedIndex = gameState.selectedHand.indexOf(index);
                if (selectedIndex > -1) {
                    gameState.selectedHand.splice(selectedIndex, 1);
                } else {
                    if (gameState.selectedHand.length < 4) {
                        gameState.selectedHand.push(index);
                    }
                }
            } else if (type === 'field') {
                const selectedIndex = gameState.selectedField.indexOf(index);
                if (selectedIndex > -1) {
                    gameState.selectedField.splice(selectedIndex, 1);
                } else {
                    if (gameState.selectedField.length < 4) {
                        gameState.selectedField.push(index);
                    }
                }
            }
            
            renderGameScreen();
        }

        function updateInstructions() {
            const instructionText = document.getElementById('instructionText');
            
            // é¸æŠæšæ•°ã‚’æ›´æ–°
            document.getElementById('handCount').textContent = gameState.selectedHand.length;
            document.getElementById('fieldCount').textContent = gameState.selectedField.length;
            
            if (gameState.selectedHand.length === 0 && gameState.selectedField.length === 0) {
                instructionText.textContent = 'æ‰‹æœ­ã‹ã‚‰æ¨ã¦ãŸã„ã‚«ãƒ¼ãƒ‰ã¨å ´ã‹ã‚‰å–ã‚ŠãŸã„ã‚«ãƒ¼ãƒ‰ã‚’åŒã˜æšæ•°é¸æŠã—ã¦ãã ã•ã„ã€‚ã©ã¡ã‚‰ã‹ã‚‰å…ˆã«é¸ã‚“ã§ã‚‚æ§‹ã„ã¾ã›ã‚“ã€‚';
            } else if (gameState.selectedHand.length > gameState.selectedField.length) {
                instructionText.textContent = `å ´ã®ã‚«ãƒ¼ãƒ‰ã‹ã‚‰${gameState.selectedHand.length - gameState.selectedField.length}æšè¿½åŠ ã§é¸æŠã—ã¦ãã ã•ã„ã€‚`;
            } else if (gameState.selectedField.length > gameState.selectedHand.length) {
                instructionText.textContent = `æ‰‹æœ­ã‹ã‚‰${gameState.selectedField.length - gameState.selectedHand.length}æšè¿½åŠ ã§é¸æŠã—ã¦ãã ã•ã„ã€‚`;
            } else if (gameState.selectedField.length === gameState.selectedHand.length && gameState.selectedHand.length > 0) {
                instructionText.textContent = 'äº¤æ›ã®æº–å‚™ãŒã§ãã¾ã—ãŸï¼';
            }
        }

        function updateActionButtons() {
            const container = document.getElementById('actionButtons');
            
            if (gameState.selectedHand.length === 0 && gameState.selectedField.length === 0) {
                container.innerHTML = `
                    <button onclick="skipExchange()" class="bg-gray-500 text-white px-6 py-3 rounded-lg font-semibold hover:bg-gray-600 transition-all duration-300">
                        äº¤æ›ã‚’ã‚¹ã‚­ãƒƒãƒ—
                    </button>
                `;
            } else if (gameState.selectedField.length === gameState.selectedHand.length && gameState.selectedHand.length > 0) {
                container.innerHTML = `
                    <button onclick="executeExchange()" class="bg-gradient-to-r from-blue-500 to-purple-500 text-white px-6 py-3 rounded-lg font-semibold hover:from-blue-600 hover:to-purple-600 transition-all duration-300 mr-4">
                        äº¤æ›ã‚’å®Ÿè¡Œã™ã‚‹
                    </button>
                    <button onclick="resetSelection()" class="bg-gray-500 text-white px-6 py-3 rounded-lg font-semibold hover:bg-gray-600 transition-all duration-300">
                        é¸æŠã‚’ãƒªã‚»ãƒƒãƒˆ
                    </button>
                `;
            } else {
                container.innerHTML = `
                    <button onclick="resetSelection()" class="bg-gray-500 text-white px-6 py-3 rounded-lg font-semibold hover:bg-gray-600 transition-all duration-300">
                        é¸æŠã‚’ãƒªã‚»ãƒƒãƒˆ
                    </button>
                `;
            }
        }

        function resetSelection() {
            gameState.selectedHand = [];
            gameState.selectedField = [];
            renderGameScreen();
        }

        function skipExchange() {
            nextRound();
        }

        function executeExchange() {
            // äº¤æ›å±¥æ­´ã‚’è¨˜éŒ²
            const discardedCards = gameState.selectedHand.map(i => gameState.hand[i]);
            const acquiredCards = gameState.selectedField.map(i => gameState.field[i]);
            
            gameState.exchangeHistory.push({
                round: gameState.round + 1,
                discarded: [...discardedCards],
                acquired: [...acquiredCards]
            });
            
            // å®Ÿéš›ã®äº¤æ›å‡¦ç†
            const newHand = [...gameState.hand];
            
            // æ‰‹æœ­ã‹ã‚‰é¸æŠã•ã‚ŒãŸã‚«ãƒ¼ãƒ‰ã‚’å‰Šé™¤ï¼ˆé€†é †ã§å‰Šé™¤ï¼‰
            gameState.selectedHand.sort((a, b) => b - a).forEach(index => {
                newHand.splice(index, 1);
            });
            
            // å ´ã‹ã‚‰é¸æŠã•ã‚ŒãŸã‚«ãƒ¼ãƒ‰ã‚’æ‰‹æœ­ã«è¿½åŠ 
            acquiredCards.forEach(card => {
                newHand.push(card);
            });
            
            gameState.hand = newHand;
            
            // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³åŠ¹æœ
            document.getElementById('gameScreen').classList.add('exchange-animation');
            setTimeout(() => {
                document.getElementById('gameScreen').classList.remove('exchange-animation');
                nextRound();
            }, 1000);
        }

        function nextRound() {
            gameState.round++;
            gameState.selectedHand = [];
            gameState.selectedField = [];
            
            if (gameState.round >= 3) {
                showFinalSelection();
            } else {
                // æ–°ã—ã„å ´ã®ã‚«ãƒ¼ãƒ‰ã‚’æº–å‚™
                const usedCards = [...gameState.hand];
                const availableCards = gameState.allCards.filter(card => !usedCards.includes(card));
                gameState.field = shuffleArray(availableCards).slice(0, 4);
                
                updateProgressBar();
                renderGameScreen();
            }
        }

        function showFinalSelection() {
            gameState.step = 2;
            
            document.getElementById('gameScreen').classList.add('hidden');
            document.getElementById('finalScreen').classList.remove('hidden');
            
            updateProgressBar();
            renderFinalCards();
        }

        function renderFinalCards() {
            const container = document.getElementById('finalCards');
            container.innerHTML = '';
            
            gameState.hand.forEach((card, index) => {
                const div = document.createElement('div');
                div.className = 'card bg-white rounded-lg shadow-lg p-6 border-2 border-gray-200 min-h-40 flex items-center justify-center text-center cursor-pointer hover:border-purple-400 relative';
                div.innerHTML = `<div class="text-gray-800 font-semibold text-lg">${card}</div>`;
                
                div.onclick = () => selectFinalCard(card, index);
                container.appendChild(div);
            });
        }

        function selectFinalCard(card, index) {
            gameState.finalCard = card;
            
            // å…¨ã¦ã®ã‚«ãƒ¼ãƒ‰ã®é¸æŠçŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
            document.querySelectorAll('#finalCards .card').forEach(el => {
                el.classList.remove('final-selected');
            });
            
            // é¸æŠã•ã‚ŒãŸã‚«ãƒ¼ãƒ‰ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
            const selectedCard = document.getElementById('finalCards').children[index];
            selectedCard.classList.add('final-selected');
            
            // ç†ç”±å…¥åŠ›ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º
            document.getElementById('reasonSection').classList.remove('hidden');
        }

        async function generateArtwork() {
            const reason = document.getElementById('reasonText').value.trim();
            
            if (!reason) {
                alert('ã‚«ãƒ¼ãƒ‰ã‚’é¸ã‚“ã ç†ç”±ã‚’æ•™ãˆã¦ãã ã•ã„ã€‚');
                return;
            }
            
            gameState.finalReason = reason;
            gameState.step = 3;
            
            document.getElementById('finalScreen').classList.add('hidden');
            document.getElementById('completeScreen').classList.remove('hidden');
            
            updateProgressBar();
            renderCompletionScreen();
            
            // çµµç”»ç”Ÿæˆã‚’é–‹å§‹
            await generateImage(gameState.finalCard, reason);
        }

        function renderCompletionScreen() {
            document.getElementById('selectedCardDisplay').textContent = gameState.finalCard;
            renderGameSummary();
        }

        function renderGameSummary() {
            const container = document.getElementById('gameSummary');
            let summaryHTML = '';
            
            // åˆæœŸæ‰‹æœ­
            summaryHTML += `
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                    <h4 class="font-semibold text-blue-800 mb-2">ğŸ´ åˆæœŸæ‰‹æœ­</h4>
                    <div class="grid grid-cols-1 gap-2">
                        ${gameState.allCards.slice(0, 4).map(card => `
                            <div class="text-sm text-blue-700 p-2 bg-white rounded border">${card}</div>
                        `).join('')}
                    </div>
                </div>
            `;
            
            // äº¤æ›å±¥æ­´
            gameState.exchangeHistory.forEach(exchange => {
                summaryHTML += `
                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-4">
                        <h4 class="font-semibold text-yellow-800 mb-2">ğŸ”„ äº¤æ› ${exchange.round}</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <div class="text-sm font-medium text-red-600 mb-1">æ‰‹æ”¾ã—ãŸã‚«ãƒ¼ãƒ‰:</div>
                                ${exchange.discarded.map(card => `
                                    <div class="text-xs text-red-700 p-2 bg-red-100 rounded border mb-1">${card}</div>
                                `).join('')}
                            </div>
                            <div>
                                <div class="text-sm font-medium text-green-600 mb-1">å–å¾—ã—ãŸã‚«ãƒ¼ãƒ‰:</div>
                                ${exchange.acquired.map(card => `
                                    <div class="text-xs text-green-700 p-2 bg-green-100 rounded border mb-1">${card}</div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            // æœ€çµ‚æ‰‹æœ­
            summaryHTML += `
                <div class="bg-purple-50 border border-purple-200 rounded-lg p-4 mb-4">
                    <h4 class="font-semibold text-purple-800 mb-2">ğŸ¤² æœ€çµ‚æ‰‹æœ­</h4>
                    <div class="grid grid-cols-1 gap-2">
                        ${gameState.hand.map(card => `
                            <div class="text-sm p-2 rounded border ${card === gameState.finalCard ? 'bg-purple-200 text-purple-800 font-bold border-purple-400' : 'bg-white text-purple-700'}">${card}</div>
                        `).join('')}
                    </div>
                </div>
            `;
            
            // é¸æŠç†ç”±
            if (gameState.finalReason) {
                summaryHTML += `
                    <div class="bg-pink-50 border border-pink-200 rounded-lg p-4">
                        <h4 class="font-semibold text-pink-800 mb-2">ğŸ’­ é¸æŠç†ç”±</h4>
                        <div class="text-sm text-pink-700 p-3 bg-white rounded border italic">
                            "${gameState.finalReason}"
                        </div>
                    </div>
                `;
            }
            
            container.innerHTML = summaryHTML;
        }

        // æ„å‘³ã®ã‚ã‚‹ã‚«ãƒ¼ãƒ‰ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒãƒƒãƒ”ãƒ³ã‚°ã‚·ã‚¹ãƒ†ãƒ 
        const safeCardPrompts = {
            // åŒ»ç™‚ãƒ»ã‚±ã‚¢é–¢é€£
            "è‡ªåˆ†ã®ä½“ãŒç—…çŠ¶ã¨ã¨ã‚‚ã«ã©ã†å¤‰åŒ–ã™ã‚‹ã‹ã‚’çŸ¥ã‚‹": "peaceful library with medical books, stethoscope on desk, warm study atmosphere, knowledge symbols",
            "åŒ»ç™‚æ©Ÿå™¨ã‚’ä½¿ç”¨ã—ãªã„": "natural healing garden, herbal plants, traditional medicine, organic wellness environment",
            "æ®‹ã£ã¦ã„ã‚‹èº«ä½“ã®æ©Ÿèƒ½ã‚’æ´»ã‹ã—ãŸã‚±ã‚¢ã‚’å—ã‘ã‚‹": "therapeutic garden, rehabilitation equipment, healing environment, recovery symbols",
            "æœ›ã‚“ã æ²»ç™‚ã‚„ã‚±ã‚¢ã‚’å—ã‘ã‚‹": "comfortable hospital room, medical chart, professional healthcare setting, caring atmosphere",
            "å°Šå³ã‚’ä¿ã¤": "elegant room with classical furniture, crown symbol, dignified atmosphere, respectful environment",
            "èª°ã‹ã®å½¹ã«ç«‹ã£ã¦ã„ã‚‹": "volunteer center, helping hands symbol, community service, meaningful contribution",
            "æ‡ºæ‚”ã™ã‚‹": "peaceful chapel interior, confession booth, spiritual reflection space, divine light",
            "æœ€æœŸã¾ã§æ€§çš„ãªæ´»å‹•ã‚’ç¶­æŒã™ã‚‹": "romantic bedroom, rose petals, intimate setting, love symbols",
            
            // äººé–“é–¢ä¿‚ãƒ»ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³
            "è‡ªåˆ†ã®æƒ³ã„ã‚’èã„ã¦ãã‚Œã‚‹äººãŒã„ã‚‹": "comfortable counseling room, empty chairs facing each other, listening ear symbol, supportive atmosphere",
            "è‡ªåˆ†ã®æœ›ã¿ã‚’å®¶æ—ã¨å…±æœ‰ã™ã‚‹": "warm living room, family discussion table, photo frames, cozy home setting",
            "è¦ªå‹ãŒè¿‘ãã«ã„ã‚‹": "friendship garden, two coffee cups, comfortable seating area, afternoon tea setting",
            "è¦ªã—ã„äººã¨æ¸©ã‹ãã¤ãªãŒã£ã¦ã„ã‚‹": "connection bridge, warm light, intertwined hands symbol, emotional bond imagery",
            "æœ€æœŸã¯èª°ã‹ã¨ä¸€ç·’ã«ã„ã‚‹": "peaceful bedroom, bedside chair, gentle presence symbols, soft natural lighting",
            "è‘¬å„€ã®å‚åˆ—è€…ã‚’ã‚ã‚‰ã‹ã˜ã‚æ±ºã‚ã¦ãŠã": "planning office, guest list, organized documents, respectful preparation",
            "å¤§åˆ‡ãªäººã«åˆ¥ã‚Œã®æŒ¨æ‹¶ã‚’ã™ã‚‹": "farewell garden, goodbye letter, emotional moment, gentle lighting",
            "è¦ªã—ã„äººã¨ãƒã‚°ã™ã‚‹": "comfort symbols, warm embrace imagery, loving atmosphere, heart shapes",
            "è‡ªåˆ†ã®æœ€æœŸãŒè¿‘ã„ã“ã¨ã‚’å®¶æ—ãŒèªã‚ã¦ã„ã‚‹": "understanding atmosphere, peaceful acceptance, family unity symbols",
            "è‡ªåˆ†ãŒå®¶æ—ã®è² æ‹…ã«ãªã‚‰ãªã„": "independence symbols, self-reliance imagery, dignified space, freedom birds",
            "è‡ªåˆ†ã®æ„æ€ã‚’ä»£å¼ã™ã‚‹æ”¯æ´è€…ãŒã„ã‚‹": "advocacy office, legal documents, professional support, consultation room",
            "ææ€–ã‚„ä¸å®‰ã«ã¤ã„ã¦è©±ã™": "therapy room, calming colors, emotional support space, peaceful environment",
            "å¿ƒã‹ã‚‰ä¿¡é ¼ã§ãã‚‹åŒ»ç™‚è€…ãŒã„ã‚‹": "medical consultation room, doctor's coat, professional care, compassionate setting",
            
            // èº«ä½“çš„ãƒ»ç²¾ç¥çš„çŠ¶æ…‹
            "æ¸…æ½”ã‚’ä¿ã¤": "clean bright bathroom, soap bubbles, organized space, gentle minimalist design",
            "æ„è­˜ãŒã¯ã£ãã‚Šã—ã¦ã„ã‚‹": "bright clear sky, sharp focus, clear thinking symbols, mental clarity",
            "ãƒ¦ãƒ¼ãƒ¢ã‚¢ã‚’ä¿ã¤": "comedy masks, joyful laughter symbols, light-hearted moments, cheerful atmosphere",
            "è‡ªå®…ã§æœ€æœŸã‚’è¿ãˆã‚‹": "comfortable home bedroom, familiar surroundings, cozy blankets, family photos",
            "ä¸å®‰ãŒãªã„": "peaceful zen garden, calm water, stress-free environment, serene atmosphere",
            "æ¯è‹¦ã—ã•ã‚„ç—›ã¿ãŒãªã„": "comfortable rest, soft pillows, relaxation scene, peaceful sleep",
            "è‡ªå®…ãƒ»æ–½è¨­ãƒ»ç—…é™¢ã‚’å•ã‚ãšé™ã‹ãªç’°å¢ƒã§éã”ã™": "quiet library, peaceful silence, serene atmosphere, minimal distraction",
            
            // è‡ªç„¶ãƒ»ç’°å¢ƒ
            "æµ·ã‚„æ£®ãªã©è‡ªç„¶ã«è§¦ã‚Œã‚‹": "beautiful ocean waves, forest trees, natural healing, environmental peace",
            "æ¡œã‚„èŠ±ã‚’æ„›ã§ã‚‹": "blooming cherry blossoms, seasonal flowers, garden beauty, natural wonder",
            "æ—…è¡Œã«å‡ºã‹ã‘ã‚‹": "travel suitcase, world map, scenic destinations, adventure spirit",
            
            // ç²¾ç¥çš„ãƒ»å®—æ•™çš„æ´»å‹•
            "è©±ã‚’èã„ã¦ãã‚Œã‚‹è‡¨åºŠå®—æ•™å¸«ãŒã„ã‚‹": "religious counseling room, spiritual books, consultation, divine comfort",
            "ã‚„ã£ã¦ã¿ãŸã‹ã£ãŸã“ã¨ã«æŒ‘æˆ¦ã™ã‚‹": "bucket list, personal achievement, success celebration, new experiences",
            "ã‚„ã‚Šæ®‹ã—ãŸä»•äº‹ã«å–ã‚Šæ›ã‹ã‚‹": "office desk, unfinished project, career satisfaction, professional accomplishment",
            "å®¶æ—ã‚„å‹äººã¨ã‚„ã‚Šæ®‹ã—ãŸã“ã¨ã‚’ç‰‡ä»˜ã‘ã‚‹": "shared workspace, teamwork, collaborative effort, completion symbols",
            
            // è¶£å‘³ãƒ»æ´»å‹•
            "å¥½ããªé‹å‹•ã‚’ã™ã‚‹": "exercise equipment, yoga mat, movement therapy, health maintenance",
            "å¥½ããªã‚‚ã®ã‚’é£Ÿã¹ã‚‹": "gourmet dining table, delicious food, culinary experience, favorite meals",
            "å¥½ããªæœ¬ã‚’èª­ã‚€": "library corner, open books, reading chair, literary escape",
            "å¥½ããªè©©ã‚’å”„ã†": "music notes, microphone, singing stage, artistic expression",
            
            // æ•´ç†ãƒ»æº–å‚™
            "ãƒ‘ã‚½ã‚³ãƒ³ã‚„ã‚¹ãƒãƒ›ã®ãƒ‡ãƒ¼ã‚¿ã‚’æ•´ç†ã™ã‚‹": "computer desk, digital files, data organization, modern technology",
            "æœ¬æ£šã®æ•´ç†ã‚’ã™ã‚‹": "organized bookshelf, literary collection, library management, book sorting",
            "ãŠé‡‘ãªã©ç›¸ç¶šã«ã¤ã„ã¦æ•´ç†ã™ã‚‹": "financial documents, inheritance papers, estate planning, money management",
            "å‰ã‚‚ã£ã¦è‡ªåˆ†ã®å¢“ã‚’ä½œã‚‹": "peaceful cemetery, memorial stone, respectful remembrance, eternal rest",
            
            // ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³
            "è¿‘æ‰€ã®äººã«æŒ¨æ‹¶ã‚’ã™ã‚‹": "neighborhood street, friendly wave, community connection, social interaction",
            "Social Network Serviceã‚„ãƒ¡ãƒ¼ãƒ«ã§æŒ¨æ‹¶ã™ã‚‹": "computer screen, social media, digital communication, online connection",
            "æœ€æœŸã«å‘¨ã‚Šã®äººã«ç¬‘ã£ã¦ã‚‚ã‚‰ã†": "joyful gathering, shared laughter, positive memories, happiness symbols",
            "éºæ›¸ã‚’æ›¸ã„ã¦ãã®åœ¨ã‚Šå‡¦ã‚’äººã«è©±ã™": "writing desk, important documents, legacy preparation, final letter",
            
            // ç‰¹åˆ¥ãªæ™‚é–“
            "å¹´è¶Šã—ã‚’ã™ã‚‹": "new year fireworks, traditional ceremony, time passage, celebration",
            "ç‘æƒ³ã«ãµã‘ã‚‹": "meditation cushion, mindful contemplation, inner peace, spiritual reflection",
            "äººç”Ÿã®æ„å‘³ã‚’å•ã†": "philosophical books, deep thinking, existential contemplation, life questions",
            "ç¥ˆã‚‹": "prayer hands, spiritual devotion, divine connection, religious symbols",
            "è‡ªåˆ†ã®å¹¸ã›ã‚’å•ã†": "happiness symbols, personal reflection, life satisfaction, contentment"
        };

        // æ„å‘³ã®ã‚ã‚‹çµµç”»ç”Ÿæˆã‚·ã‚¹ãƒ†ãƒ ï¼ˆå®‰å…¨æ€§ã‚’ä¿ã¡ã¤ã¤å…·ä½“çš„ã«ï¼‰
        function generatePrompt(cardText, reason) {
            const qualityTags = 'masterpiece, best quality, ultra detailed, 8k resolution, meaningful illustration, symbolic art';
            
            // ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆå‚ç…§ã‚’ãƒ©ãƒ³ãƒ€ãƒ é¸æŠ
            const artists = [
                "in the style of Annie Leibovitz emotional portraiture",
                "reminiscent of Steve McCurry human stories",
                "inspired by Gregory Crewdson cinematic storytelling",
                "with the emotional depth of Richard Avedon",
                "capturing essence like Henri Cartier-Bresson decisive moments"
            ];
            const selectedArtist = artists[Math.floor(Math.random() * artists.length)];
            
            // ã‚ˆã‚Šå…·ä½“çš„ã§æ„å‘³ã®ã‚ã‚‹ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒãƒƒãƒ”ãƒ³ã‚°
            let theme = safeCardPrompts[cardText] || 'peaceful landscape with meaningful objects, gentle atmosphere, symbolic elements';
            
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è¨˜è¿°ã‹ã‚‰å…·ä½“çš„ãªè¦ç´ ã‚’æŠ½å‡º
            const meaningfulElements = {
                'å®¶æ—': 'family home, warm kitchen, dining table with empty chairs, family photos on wall',
                'å‹äºº': 'park bench, coffee shop, shared memories, friendship symbols',
                'å¹³å’Œ': 'zen garden, meditation space, calm water, peaceful nature',
                'å®‰å¿ƒ': 'cozy bedroom, soft blankets, warm fireplace, comfortable space',
                'æ„›': 'heart-shaped objects, romantic garden, love letters, gentle roses',
                'å¸Œæœ›': 'sunrise, lighthouse, bright horizon, blooming flowers',
                'æ„Ÿè¬': 'thank you notes, gift boxes, appreciation symbols, warm light',
                'è‡ªç„¶': 'beautiful landscape, trees, mountains, ocean waves',
                'éŸ³æ¥½': 'musical instruments, sheet music, concert hall, sound waves',
                'æœ¬': 'library, bookshelf, reading corner, open books',
                'é£Ÿäº‹': 'dining table, delicious food, kitchen utensils, cooking scene',
                'æ—…è¡Œ': 'travel suitcase, world map, passport, scenic destinations'
            };
            
            let elementPrompt = 'meaningful symbolic objects';
            for (const [keyword, elements] of Object.entries(meaningfulElements)) {
                if (reason.includes(keyword) || cardText.includes(keyword)) {
                    elementPrompt = elements;
                    break;
                }
            }
            
            // ã‚«ãƒ¼ãƒ‰ã®å†…å®¹ã«åŸºã¥ã„ãŸè‰²èª¿
            const emotionColors = {
                'å®¶æ—': 'warm golden sunset colors',
                'å‹äºº': 'friendly blue sky tones',
                'å¹³å’Œ': 'soft green nature palette',
                'å®‰å¿ƒ': 'gentle pink and cream shades',
                'æ„›': 'warm red and pink accents',
                'å¸Œæœ›': 'bright yellow sunrise light',
                'æ„Ÿè¬': 'orange autumn colors'
            };
            
            let colorPrompt = 'soft natural colors';
            for (const [emotion, color] of Object.entries(emotionColors)) {
                if (reason.includes(emotion)) {
                    colorPrompt = color;
                    break;
                }
            }
            
            const style = 'meaningful illustration, symbolic objects, emotional atmosphere, no human faces, no people, peaceful scene';
            const enhancement = '(meaningful symbolism:1.4), (no people:1.8), (no human figures:1.8), (safe content:1.8), (peaceful:1.4), (symbolic:1.3)';
            
            return `${qualityTags}, ${selectedArtist}, ${theme}, ${elementPrompt}, ${colorPrompt}, ${style}, ${enhancement}`;
        }

        function generateNegativePrompt() {
            return 'nsfw, explicit, sexual, inappropriate, violence, disturbing, people, human figures, faces, bodies, children, minors, adults, persons, individuals, lowres, blurry, jpeg artifacts, watermark, signature, bad anatomy, text, logo, cropped, worst quality, low quality, normal quality, username, realistic people, human portraits, character depictions';
        }

        async function generateImage(cardText, reason) {
            const statusDiv = document.getElementById('generationStatus');
            const containerDiv = document.getElementById('artworkContainer');
            
            try {
                statusDiv.textContent = 'çµµç”»ã‚’ç”Ÿæˆä¸­...';
                containerDiv.innerHTML = '<div class="animate-spin text-4xl">ğŸ¨</div>';
                
                const prompt = generatePrompt(cardText, reason);
                const negativePrompt = generateNegativePrompt();
                
                console.log('Generated prompt:', prompt);
                
                // AI Horde APIã«ç”Ÿæˆãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡
                const generateResponse = await fetch('https://stablehorde.net/api/v2/generate/async', {
                    method: 'POST',
                    mode: 'cors',
                    headers: {
                        // GitHub Actions ã§ç”Ÿæˆã•ã‚Œã‚‹ config.js ã®å€¤ã‚’åˆ©ç”¨
                        'apikey': (window && window.MINLABO_APIKEY) ? window.MINLABO_APIKEY : '',
                        'Client-Agent': 'MinLaboCardGame:1.0:minlabo@example.com',
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        prompt: prompt,
                        models: ['stable_diffusion'],
                        params: {
                            n: 1,
                            steps: 25,
                            width: 768,
                            height: 768,
                            cfg_scale: 7,
                            sampler_name: "k_euler_a"
                        },
                        nsfw: false
                    })
                });
                
                const generateData = await generateResponse.json();
                
                if (!generateData.id) {
                    throw new Error('ç”Ÿæˆãƒªã‚¯ã‚¨ã‚¹ãƒˆã®é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
                
                const jobId = generateData.id;
                statusDiv.textContent = `ç”Ÿæˆä¸­... (ID: ${jobId.substring(0, 8)}...)`;
                
                // çµæœã‚’ãƒãƒ¼ãƒªãƒ³ã‚°
                let attempts = 0;
                const maxAttempts = 60;
                
                while (attempts < maxAttempts) {
                    await new Promise(resolve => setTimeout(resolve, 5000));
                    attempts++;
                    
                    const statusResponse = await fetch(`https://stablehorde.net/api/v2/generate/status/${jobId}`, {
                        mode: 'cors',
                        headers: {
                            'apikey': (window && window.MINLABO_APIKEY) ? window.MINLABO_APIKEY : '',
                            'Client-Agent': 'MinLaboCardGame:1.0:minlabo@example.com',
                            'Accept': 'application/json'
                        }
                    });
                    
                    const statusData = await statusResponse.json();
                    
                    if (statusData.generations && statusData.generations.length > 0) {
                        const imageUrl = statusData.generations[0].img;
                        containerDiv.innerHTML = `
                            <img src="${imageUrl}" alt="Generated artwork" 
                                 class="w-full h-full object-cover rounded-lg shadow-lg">
                        `;
                        statusDiv.innerHTML = `
                            <span class="text-green-600">âœ… çµµç”»ç”Ÿæˆå®Œäº†ï¼</span><br>
                            <a href="${imageUrl}" target="_blank" class="text-blue-500 hover:underline text-xs">
                                ç”»åƒã‚’æ–°ã—ã„ã‚¿ãƒ–ã§é–‹ã
                            </a>
                        `;
                        return;
                    } else if (statusData.faulted) {
                        throw new Error('ç”Ÿæˆå‡¦ç†ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
                    } else {
                        const queuePosition = statusData.queue_position || 0;
                        const waitTime = statusData.wait_time || 0;
                        statusDiv.textContent = `ç”Ÿæˆä¸­... (ã‚­ãƒ¥ãƒ¼: ${queuePosition}, å¾…æ©Ÿ: ${Math.round(waitTime)}ç§’)`;
                    }
                }
                
                throw new Error('ç”ŸæˆãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ');
                
            } catch (error) {
                console.error('çµµç”»ç”Ÿæˆã‚¨ãƒ©ãƒ¼:', error);
                statusDiv.innerHTML = `
                    <span class="text-red-600">âŒ ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ</span><br>
                    <span class="text-xs">${error.message}</span><br>
                    <button onclick="retryImageGeneration()" class="mt-2 bg-blue-500 text-white px-4 py-2 rounded text-sm hover:bg-blue-600 transition-colors">
                        ğŸ”„ å†è©¦è¡Œ
                    </button>
                `;
                containerDiv.innerHTML = `
                    <div class="text-4xl text-gray-400">ğŸ¨</div>
                    <div class="text-xs text-gray-500 mt-2">ç”Ÿæˆå¤±æ•—</div>
                `;
            }
        }


        
        function retryImageGeneration() {
            generateImage(gameState.finalCard, gameState.finalReason);
        }

        function wrapTextImproved(ctx, text, maxWidth) {
            const lines = [];
            let currentLine = '';
            
            // æ—¥æœ¬èªã®å ´åˆã¯æ–‡å­—å˜ä½ã§åˆ†å‰²
            for (let i = 0; i < text.length; i++) {
                const char = text[i];
                const testLine = currentLine + char;
                const metrics = ctx.measureText(testLine);
                
                if (metrics.width > maxWidth && currentLine.length > 0) {
                    lines.push(currentLine);
                    currentLine = char;
                } else {
                    currentLine = testLine;
                }
            }
            
            if (currentLine.length > 0) {
                lines.push(currentLine);
            }
            
            return lines;
        }
        


        function restartGame() {
            gameState = {
                step: 0,
                round: 0,
                hand: [],
                field: [],
                selectedHand: [],
                selectedField: [],
                finalCard: null,
                finalReason: '',
                exchangeHistory: [],
                allCards: []
            };
            
            document.getElementById('completeScreen').classList.add('hidden');
            document.getElementById('startScreen').classList.remove('hidden');
            document.getElementById('reasonText').value = '';
            document.getElementById('reasonSection').classList.add('hidden');
            
            updateProgressBar();
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'97aae6b6b142b557',t:'MTc1NzEyOTU2OC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
